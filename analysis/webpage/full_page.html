
<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

	<link rel="stylesheet" href="styling.css">
	
	<script>
		url = window.location.href;
		
		var end_character = url.indexOf('&', url.indexOf('PROJECT_ID='));
		if( end_character == -1 ) { end_character=url.length; }
		PROJECT_ID = url.substring( url.indexOf('PROJECT_ID=')+11, end_character );
		
		if( url.indexOf('localhost') != -1 ){ base_url = url.substring( 0, url.indexOf('/', url.indexOf('localhost'))+1 ) }
		else if( url.indexOf('analysis') != -1 ) { base_url = url.substring( 0, url.indexOf('analysis')+9 ) }
		else {alert('Configuration only written for base url\'s in analysis server or localhost, webpage may not work as expected');}
		
		if( url.indexOf( 'PROJECT_ID=' ) == -1 ) {alert("No project ID given, try using the url :\n" + base_url + "webpage/full_page.html?PROJECT_ID=<project-id>");}

		// NEED TO DO SOMETHING IF PROJECT_ID IS EMPTY
		// ALSO NEED TO DO SOMETHING IF PROJECT_ID DOES NOT EXIST
		
		json_url = base_url + "data-files/" + PROJECT_ID + ".json";
		pdb_url = base_url + "visualizer/pdbfiles/" + PROJECT_ID + ".pdb"
		trj_url = base_url + "visualizer/trjfiles/" + PROJECT_ID + ".xtc"
		
		var system;
		var xhttp = new XMLHttpRequest();
		xhttp.open("GET", base_url + "data-files/" + PROJECT_ID + ".json", true);
		
		function urlExists(testUrl) {
			var http = jQuery.ajax({
				type:"HEAD",
				url:testUrl,
				async:false })
			return http.status!=404;}

		if( !urlExists( json_url ) || !urlExists( pdb_url ) || !urlExists( trj_url ) ) {alert('At least one of the project files is not accessible');}
		
	</script>

</head>

<body>

	<!-- <div id="loading"><img id="loading-image" alt="Loading Trajectory..."/></div> -->
	
	<div id="chart-container" class="block"><canvas id="chart" style="max-height:100%"></canvas></div>
	
	<div id="chart-type-container" class="border">
	<input type="radio" name="chart-type" onClick="make_chart('bonds');" checked /><label id="chart-bonds">Number of Bonds</label> &emsp;
	<input type="radio" name="chart-type" onClick="make_chart('single_staples');" /><label id="chart-single">Single-Bound Staples</label> &emsp;
	<input type="radio" name="chart-type" onClick="make_chart('double_staples');" /><label id="chart-double">Double-Bound Staples</label> &emsp;
	<input type="radio" name="chart-type" onClick="make_chart('longest_staple');" /><label id="chart-longest">Longest Bound Distance</label>
	</div>
	
	<div class="center"><h1 id="canvas-header">Loading canvas display...</h1></div>
	<div id="canvas-container" class="block"><canvas id="canvas"></canvas></div>
	
	<div id="reset-container" class="border">
	<button type="button" onclick="center_canvas();">Center Canvas</button> &emsp;
	<input type="radio" name="canvas-type" onclick="show_strands();" checked>All Strands</input> &emsp;
	<input type="radio" name="canvas-type" onclick="show_domains();">Matching Domains</input> &emsp;
	<input type="radio" name="canvas-type" onclick="show_bonds();">Bounded Strands</input> &emsp;
	<button type="button" onclick="select_all();">Select All Strands</button> &emsp;
	<button type="button" onclick="deselect_all();">Deselect All Strands</button>
	</div>
	
	<div id="htmol-container" class="block"><iframe id="iframe" scrolling="no" width="100%" height="650"></iframe></div>
	
	<script src="graph.js"></script>
	<script src="bonds.js"></script>
	<script src="origami.js"></script>
	
	<script>
	
		// Create IE + others compatible event handler
		var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
		var eventer = window[eventMethod];
		var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";

		// Listen to message from child window
		eventer(messageEvent,function(event) {
			//console.log(event.data);
			//console.log( frame_to_time[ parseInt(event.data) ] );
			if( !isNaN(event.data) ) {
				updateALL( frame_to_time[ parseInt(event.data) ], false ); }
			//else if ( event.data == 'Trajectory File Loaded' ) {
				//console.log('Trajectory File Loaded');}
		},false);

	</script>
	
	<script>
	
		xhttp.onload = function () {
			if (xhttp.readyState === xhttp.DONE) {
				if (xhttp.status === 200) {
				
					system = JSON.parse(xhttp.responseText);
					
					//necessary for origami scripts
					designate_backbone(1);
					
					console.log('Graphing bonds');
					make_bond_data();
					make_chart();
					initConfVariables();
					
					//origami scripts - not for general use
					console.log('Computing matching domains');
					//compute_matching_domains();
					compute_with_assumptions();
					console.log('Computing origami statistics');
					compute_origami_statistics();
					
					console.log('FINISHED');
					updateALL( frame_to_time[0] );
					
				}
			}
		};
		
		xhttp.send();
		
		document.getElementById('iframe').src = base_url+"visualizer/HTMoL.html?PROJECT_ID="+PROJECT_ID;
		
	</script>

</body>

</html>